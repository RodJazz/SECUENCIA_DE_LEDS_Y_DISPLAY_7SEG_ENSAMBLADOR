;AUTOR:Calle Condori Rodrigo
;EJERCICIO 2:
;Realizar un contador del 0 al 9 utilizando un display de 7 segmentos de cátodo común. 
;El display tiene un coficador 7448 conectado al puerto B, en los pines RB<3:0>
PROCESSOR 16F877A            ;SELECCION DEL PIC 16F877A
#include <xc.inc>            ;FICHERO COMPILADOR XC
;CONFIGURACION DE LOS FUSIBLES
    CONFIG  FOSC = XT        ;TIPO DE OSCILADOR XT PARA UN CRISTAL DE 4MHZ
    CONFIG  WDTE = OFF       ;WATCHDOG
    CONFIG  PWRTE = ON       ;ACTIVASIÓN DE RETARDO CUANDO SE ENCIENDE EL PIC ESPERA 500ms PARA LUEGO RECIEN EMPEZAR A PROCESAR EL CODIGO
    CONFIG  CP = OFF         ;CÓDIGO DE PROTECCIÓN
    CONFIG  BOREN = OFF      ;RESETEO DEL MICRO POR DEBAJO DE LA TENSIÓN NOMINAL, DESACTIVADO
    CONFIG  LVP = OFF        ;RESERVA DEL PIN RB3 PARA PROGRAMACIÓN, DESACTIVADO
;REGISTROS AUXILIARES    
    UNIDAD   EQU   0X20      ;ALMACENA EN LA DIRECCION 0X20
    CONT1    EQU   0X21      ;ALMACENA EN LA DIRECCION 0X21
    CONT2    EQU   0X22      ;ALMACENA EN LA DIRECCION 0X22
    CONT3    EQU   0X23      ;ALMACENA EN LA DIRECCION 0X23
     
psect   RESET_VECT,class=CODE,delta=2 ; VECTOR DE RESET
RESET_VECT:
	       PAGESEL CONFIGURACION   
               GOTO  CONFIGURACION    ;IR A LA ETIQUETA CONFIGURACION
psect   INT_VECT,class=CODE,delta=2   ;VECTOR DE INTERRUPCION
INT_VECT:
               RETFIE
PSECT CODE, delta=2
CONFIGURACION:
    BSF    STATUS,5        ;INGRSAMOS AL BANCO 1
    BCF    STATUS,6       
    CLRF   TRISB           ;EL PUERTO B COMO SALIDA
    BCF    STATUS,5        ;INGRESAMOS AL BANCO 0
    BCF    STATUS,6
    CLRF   PORTB           ;LIMPIAMOS EL PUERTO B
    CLRF   UNIDAD          ;EL REGISTRO UNIDAD=00h
;---------------------
MAIN:
    CALL   VISUALIZAR      ;LLAMADA A SUBRUTINA VISUALIZAR
    CALL   INTERNO         ;LLAMADA A SUBRUTINA INTERNO
    GOTO   MAIN            ;CIERRA EL BUCLE PRINCIPAL
;---------------------    
VISUALIZAR:
    MOVF   UNIDAD,W        ;MOVER EL VALOR DEL REGISTRO UNIDAD AL REGISTRO 'W'
    CALL   TABLA           ;LLAMADA A SUBRUTINA TABLA
    MOVWF  PORTB           ;MOVER EL CONTENIDO DEL REGISTRO DE TRABAJO AL REGISTRO PORTB
    CALL   RETARDO         ;LLAMADA A SUBRUTINA RETARDO
    RETURN                 ;RETORNAR 
TABLA:
    ADDWF  PCL,F           ;PCL=PCL+W
    RETLW  00h             ;0
    RETLW  01h             ;1
    RETLW  02h             ;2
    RETLW  03h             ;3
    RETLW  04h             ;4
    RETLW  05h             ;5
    RETLW  06h             ;6
    RETLW  07h             ;7
    RETLW  08h             ;8
    RETLW  09h             ;9
INTERNO:
    INCF   UNIDAD,F        ;INCREMENTAR EL REGISTROUNIDAD Y GUARDARLO EN EL MISMO REGISTRO
    MOVLW  10              ;MOVER EL LITERAL 10 AL REGISTRO 'W'(LIMITE DEL CONTADOR DEL DISPLAY)
    SUBWF  UNIDAD,W        ;RESTAR EL CONTENIDO DEL REGISTRO 'W' DEL REGISTRO UNIDAD I GUARDARLO EN 'W' -> W=UNIDAD-W
    BTFSS  STATUS,2        ;REALIZAR UN SALTO SI LA BANDERA 'Z' ESTA EN 1
    RETURN                 ;LA BANDERA 'Z' VALE 0 NO SALTA, RETORNA DE LA SUBRUTINA
    CLRF   UNIDAD          ;LA BANDERA 'Z' VALE 1 SALTA, LIMPIA UNIDAD, UNIDAD=0h
    RETURN                 ;RETORNDO DE LA SUBRUTINA
;---------------SUBRUTINA DE RETARDO PARA UN TIEMPO DE 2 SEG--------------------
RETARDO:
    MOVLW  117  
    MOVWF  CONT3
BUCLE3:
    MOVLW  56
    MOVWF  CONT2
BUCLE2:
    MOVLW  100
    MOVWF  CONT1
BUCLE1:
    DECFSZ CONT1,F
    GOTO   BUCLE1
    DECFSZ CONT2,F
    GOTO   BUCLE2
    DECFSZ CONT3,F
    GOTO   BUCLE3
    RETURN
;-------------------------------------------------------------------------------
    END RESET_VECT


    