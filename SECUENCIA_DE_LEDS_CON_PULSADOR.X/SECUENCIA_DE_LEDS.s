;AUTOR:Calle Condori Rodrigo
;EJERCICIO 1:
;SELECCIONAR UNA SECUENCIA DE LEDs CONECTADOS AL PUERTO B CON UN PULSADOR PULL DOWN CONECTADO AL PIN RD0
PROCESSOR 16F877A            ;SELECCION DEL PIC 16F877A
#include <xc.inc>            ;FICHERO COMPILADOR XC
;CONFIGURACION DE LOS FUSIBLES
    CONFIG  FOSC = XT        ;TIPO DE OSCILADOR XT PARA UN CRISTAL DE 4MHZ
    CONFIG  WDTE = OFF       ;WATCHDOG
    CONFIG  PWRTE = ON       ;ACTIVASIÓN DE RETARDO CUANDO SE ENCIENDE EL PIC ESPERA 500ms PARA LUEGO RECIEN EMPEZAR A PROCESAR EL CODIGO
    CONFIG  CP = OFF         ;CÓDIGO DE PROTECCIÓN
    CONFIG  BOREN = OFF      ;RESETEO DEL MICRO POR DEBAJO DE LA TENSIÓN NOMINAL, DESACTIVADO
    CONFIG  LVP = OFF        ;RESERVA DEL PIN RB3 PARA PROGRAMACIÓN, DESACTIVADO
    
    ;VARIABLES AUXILIARES
    CONTADOR    EQU  0X30    
    CONT1       EQU  0X31
    CONT2       EQU  0X32
psect   RESET_VECT,class=CODE,delta=2 ; PIC10/12/16
RESET_VECT:
	       PAGESEL CONFIGURACION
               GOTO  CONFIGURACION
psect   INT_VECT,class=CODE,delta=2 ; PIC10/12/16
INT_VECT:
               RETFIE
PSECT CODE, delta=2
CONFIGURACION:
               BSF   STATUS,5      ;INGRESAMOS AL BANCO 1
	       BCF   STATUS,6
	       CLRF  TRISB         ;SE CONFIGURA EL PUERTO B COMO SALIDA
	       BSF   TRISD,0       ;EL BIT RD0 SE CONFIGURA COMO ENTRADA
	       BCF   STATUS,5      ;INGRESAMOS AL BANCO 0
	       CLRF  PORTB         ;LIMPIAMOS EL PUERTO B
	       CLRF  PORTD         ;LIMPIAMOS EL PUERTO D
;BUCLE PRINCIPAL-----------------
MAIN:
               CALL  VISUALIZAR    ;SUBRUTINA VISUALIZAR
;---------ANTIRREBOTE------------
               BTFSS PORTD,0       ;TESTEAMOS SI EL BIT RB0 ESTA EN 1 LOGICO, SI ESTA EN 1 LOGICO REALIZA UN SALTO
	       GOTO  MAIN          ;NO ESTA EN 1 LOGICO	       
	       CALL  RETARDO       ;SUBRUTINA RETARDO,VARIAR PARA OBTENER UNA PULSACION MAS PRECISA Y SIN REBOTES DEL PULSADOR
;--------------------------------	
	       BTFSS PORTD,0       ;NUEVAMENTE REALIZA EL TESTEO   
	       GOTO  MAIN          ;NO SE A PRESIONADO EL PULSADOR
	       CALL  INCREMENTAR   ;LLAMA A LA SUBRUTINA INCREMENTAR
	       GOTO  MAIN          ;CIERRA EL BUCLE PRINCIPAL
;-------------------------------	       
INCREMENTAR:
	       INCF  CONTADOR,F    ;INCREMENTAMOS EL REGISTRO AUXILIAR
	       MOVLW 5             ;VALOR LIMITE DEL REGISTRO CONTADOR
	       SUBWF CONTADOR,W    ;W=CONTADOR-W
	       BTFSS STATUS,2      ;LA BANDERA 'Z' ESTA ACTIVADO
	       RETURN              ;NO ESTA ACTIVADO,NO SALTA Y EJECUTA RETURN
	       CLRF  CONTADOR      ;LA BANDERA 'Z' ESTÁ ACTIVADO Y AQUI ES DONDE LLEGA CUANDO SALTA 
	       RETURN              ;REGRASA AL PROGRAMA DONDE SE REALIZO LA LLAMADA A SUBRUTINA
VISUALIZAR:
               MOVF  CONTADOR,W    ;SE MUEVE TODO EL CONTENIDO DEL REGISTRO CONTADOR AL REGISTRO DE TRABAJO
	       CALL  TABLA_DE_SEC  ;REALIZA LA LLAMADA A SUBRUTINA 
	       MOVWF PORTB         ;MUEVE EL CONTENIDO DEL REGISTRO DE TRABAJO 'W' AL REGISTRO PORTB
	       RETURN              ;RETORNO DE SUBRUTINA
;SUBRUTINA TABLA, EN ESTÁ SUBUTINA SE ENCUENTRA LAS SECUENCIAS, PUEDE AÑADIRSE MAS 	       
TABLA_DE_SEC:  
               ADDWF PCL,F         ;REALIZA LA SUMA DEL REGISTRO PCL CON EL REGISTOR 'W' PCL=PCL+W
               RETLW 11001100B    ;SECUENCIA 1
	       RETLW 11100111B    ;SECUENCIA 2
	       RETLW 10101010B    ;SECUENCIA 3
	       RETLW 10011001B    ;SECUENCIA 4
	       RETLW 10000001B    ;SECUENCIA 5
;SUBRUTINA DE RETARDO CON UN TIEMPO APROXIMADO A 80ms	       
RETARDO:
               MOVLW 176           
	       MOVWF CONT2
BUCLE2:
	       MOVLW 150
	       MOVWF CONT1
BUCLE1:
               DECFSZ CONT1,F
	       GOTO   BUCLE1
	       DECFSZ CONT2,F
	       GOTO   BUCLE2
	       RETURN
	       END    RESET_VECT
